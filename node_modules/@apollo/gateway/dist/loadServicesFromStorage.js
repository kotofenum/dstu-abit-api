"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const graphql_1 = require("graphql");
const envOverridePartialSchemaBaseUrl = 'APOLLO_PARTIAL_SCHEMA_BASE_URL';
const envOverrideStorageSecretBaseUrl = 'APOLLO_STORAGE_SECRET_BASE_URL';
const urlFromEnvOrDefault = (envKey, fallback) => (process.env[envKey] || fallback).replace(/\/$/, '');
const urlPartialSchemaBase = urlFromEnvOrDefault(envOverridePartialSchemaBaseUrl, 'https://storage.googleapis.com/engine-partial-schema-prod/');
const urlStorageSecretBase = urlFromEnvOrDefault(envOverrideStorageSecretBaseUrl, 'https://storage.googleapis.com/engine-partial-schema-prod/');
function getStorageSecretUrl(graphId, apiKeyHash) {
    return `${urlStorageSecretBase}/${graphId}/storage-secret/${apiKeyHash}.json`;
}
function fetchApolloGcs(fetcher, ...args) {
    const [input, init] = args;
    const url = typeof input === 'object' && input.url || input;
    return fetcher(input, init)
        .catch(fetchError => {
        throw new Error("Cannot access Apollo Graph Manager storage: " + fetchError);
    })
        .then((response) => __awaiter(this, void 0, void 0, function* () {
        if (response.ok || response.status === 304) {
            return response;
        }
        const body = yield response.text();
        if (response.headers.get('content-type') === 'application/xml' &&
            response.status === 403 &&
            body.includes("<Error><Code>AccessDenied</Code>") &&
            body.includes("Anonymous caller does not have storage.objects.get")) {
            throw new Error("Unable to authenticate with Apollo Graph Manager storage " +
                "while fetching " + url + ".  Ensure that the API key is " +
                "configured properly and that a federated service has been " +
                "pushed.  For details, see " +
                "https://go.apollo.dev/g/resolve-access-denied.");
        }
        throw new Error("Could not communicate with Apollo Graph Manager storage: " + body);
    }));
}
;
function getServiceDefinitionsFromStorage({ graphId, apiKeyHash, graphVariant, federationVersion, fetcher, }) {
    return __awaiter(this, void 0, void 0, function* () {
        const storageSecretUrl = getStorageSecretUrl(graphId, apiKeyHash);
        const secret = yield fetchApolloGcs(fetcher, storageSecretUrl).then(res => res.json());
        if (!graphVariant) {
            graphVariant = 'current';
        }
        const baseUrl = `${urlPartialSchemaBase}/${secret}/${graphVariant}/v${federationVersion}`;
        const compositionConfigResponse = yield fetchApolloGcs(fetcher, `${baseUrl}/composition-config-link`);
        if (compositionConfigResponse.status === 304) {
            return { isNewSchema: false };
        }
        const linkFileResult = yield compositionConfigResponse.json();
        const compositionMetadata = yield fetchApolloGcs(fetcher, `${urlPartialSchemaBase}/${linkFileResult.configPath}`).then(res => res.json());
        const serviceDefinitions = yield Promise.all(compositionMetadata.implementingServiceLocations.map(({ name, path }) => __awaiter(this, void 0, void 0, function* () {
            const { url, partialSchemaPath } = yield fetcher(`${urlPartialSchemaBase}/${path}`).then(response => response.json());
            const sdl = yield fetcher(`${urlPartialSchemaBase}/${partialSchemaPath}`).then(response => response.text());
            return { name, url, typeDefs: graphql_1.parse(sdl) };
        })));
        return {
            serviceDefinitions,
            compositionMetadata,
            isNewSchema: true,
        };
    });
}
exports.getServiceDefinitionsFromStorage = getServiceDefinitionsFromStorage;
//# sourceMappingURL=loadServicesFromStorage.js.map